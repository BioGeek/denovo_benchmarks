"""
Script to convert predictions from the algorithm output format 
to the common output format.
"""

import argparse
import re
import os
import pandas as pd
from tqdm import tqdm
from pyteomics import mgf
from base import OutputMapperBase


class OutputMapper(OutputMapperBase):
    REPLACEMENTS = {
        "C+57.021": "C[UNIMOD:4]",
        # Amino acid modifications.
        "M+15.995": "M[UNIMOD:35]",    # Met oxidation
        "N+0.984": "N[UNIMOD:7]",     # Asn deamidation
        "Q+0.984": "Q[UNIMOD:7]",     # Gln deamidation
        # N-terminal modifications.
        "+42.011": "[UNIMOD:1]-",      # Acetylation
        "+43.006": "[UNIMOD:5]-",      # Carbamylation
        "-17.027": "[UNIMOD:385]-",     # NH3 loss
        "+43.006-17.027": "[UNIMOD:5][UNIMOD:385]-",   # Carbamylation and NH3 loss
    }

    def __init__(self, input_dir: str) -> None:
        """TODO."""
        # FIXME: this won't work if spectra in different files have identical titles!
        
        fnames = [fname for fname in os.listdir(input_dir) if fname.endswith(".mgf")]
        self.file_names = [fname.split(".")[0] for fname in sorted(fnames)]

        self.title2spec_idx = {}
        for fname in self.file_names:
            print(fname, ": get spectrum indices.")
            filename = os.path.join(input_dir, fname + ".mgf")
            spectra = mgf.read(filename)
            for i in tqdm(range(len(spectra))):
                spectrum_title = spectra[i]["params"]["title"]
                self.title2spec_idx[spectrum_title] =  f"{fname}:{i}"
            spectra.close()
        return

    def format_spectrum_id(self, spectrum_id: str) -> str:
        """
        TODO.
        Transform spectrum id generated by the algorithm to the common format
        `filename.scan.scan.charge` -> `filename:spectrum_idx`.
        """

        spectrum_title = spectrum_id
        spectrum_id = self.title2spec_idx[spectrum_title]
        return spectrum_id

    def format_sequence(self, sequence):
        """
        Convert peptide sequence to the common output data format 
        (ProForma with modifications represented with 
        Unimod accession codes, e.g. M[UNIMOD:35]).

        Parameters
        ----------
        sequence : str
            Peptide sequence in the original algorithm output format.

        Returns
        -------
        transformed_sequence : str
            Peptide sequence in the common output data format.  
        """
        sequence = eval(sequence)
        
        # Represent modifications as UNIMOD codes
        sequence = [self.REPLACEMENTS.get(token, token) for token in sequence]

        sequence = "".join(sequence)
        
        # Fix for the case when multiple N-term modifications 
        # are predicted in a row. Removes redundant dashes. 
        sequence = sequence.replace("]-[", "][")

        return sequence
    

parser = argparse.ArgumentParser()
parser.add_argument(
    "--output_path", required=True, help="The path to the algorithm predictions file."
)
parser.add_argument(
    "--input_dir", required=True, help="The dir with the input dataset .mgf files.",
)
args = parser.parse_args()

# Read predictions from output file
output_data = pd.read_csv(args.output_path, sep="\t")

# Transform data to the common output format
output_mapper = OutputMapper(input_dir=args.input_dir)
output_data = output_mapper.format_output(output_data)

# Save processed predictions to outputs.csv
# (the expected name for the algorithm output file)
output_data.to_csv("outputs.csv", index=False)
